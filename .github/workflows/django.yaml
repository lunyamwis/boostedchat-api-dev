name: Django CI

on:
  push:
    branches: [ actions-test ]
    # branches: [ "*" ] 
  # pull_request:
  #   branches: [ "*" ]
  #   types: [opened, closed, reopened]

env:
  CELERY_BROKER_URL_API: $CELERY_BROKER_URL_API
  CELERY_RESULT_BACKEND_API: $CELERY_RESULT_BACKEND_API
  MAILCHIMP_API_KEY: $MAILCHIMP_API_KEY
  MAILCHIMP_DATA_CENTER: $MAILCHIMP_DATA_CENTER
  MAILCHIMP_EMAIL_LIST_ID: $MAILCHIMP_EMAIL_LIST_ID
  EMAIL_HOST_USER: $EMAIL_HOST_USER
  EMAIL_HOST_PASSWORD: $EMAIL_HOST_PASSWORD
  IG_USERNAME: ${{SECRETS.IG_USERNAME}}
  IG_PASSWORD: ${{SECRETS.IG_PASSWORD}}
  CHALLENGE_EMAIL: ${{SECRETS.CHALLENGE_EMAIL}}
  CHALLENGE_PASSWORD: ${{SECRETS.CHALLENGE_PASSWORD}}

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.9]
    steps:
    - uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    # - name: Run Tests
    #   run: |
    #     python manage.py test

    - name: Login To Docker Hub
      uses: docker/login-action@v3 # mr-smithers-excellent/docker-build-push@v4 # use existing coker action
      with:
        context: .
        # push: true
        # tags: lunyamwimages/boostedchat-api-dev:latest
        # registry: docker.io
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }} 

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: lunyamwimages/boostedchatapi-dev:staging

    - name: Set up ssh agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.STAGING_DEPLOY_SSH_PRIVATE_KEY }}

    - name: Add server to known_hosts
      run: |
        ssh-keyscan -H 84.247.184.136 >> ~/.ssh/known_hosts
  
    - name: Pull latest image and builde docker
      #'docker pull lunyamwimages/boostedchatapi-dev:staging && docker stop boostedchatapi-dev || true && docker rm boostedchatapi-dev || true && docker run -d --name boostedchatapi-dev lunyamwimages/boostedchatapi-dev:staging'
      run: |
        ssh ubuntu@84.247.184.136 'echo "I AM IN THE SERVER"'
      env:
        SSH_PRIVATE_KEY: ${{ secrets.STAGING_DEPLOY_SSH_PRIVATE_KEY }}

    - name: SSH to Staging Server
      run: |
        ssh ubuntu@84.247.184.136 'docker pull lunyamwimages/boostedchatapi-dev:staging && docker stop boostedchat-api-dev || true && docker rm boostedchat-api-dev || true && docker run -d --name boostedchat-api-dev lunyamwimages/boostedchatapi-dev:staging'
      env:
        SSH_PRIVATE_KEY: ${{ secrets.STAGING_DEPLOY_SSH_PRIVATE_KEY }}